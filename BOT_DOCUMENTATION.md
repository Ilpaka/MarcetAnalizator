# Документация по работе Crypto Trading Bot

## Содержание
1. [Обзор системы](#обзор-системы)
2. [Архитектура](#архитектура)
3. [Основные компоненты](#основные-компоненты)
4. [Процесс торговли](#процесс-торговли)
5. [Управление ордерами](#управление-ордерами)
6. [Управление позициями](#управление-позициями)
7. [Ручная торговля](#ручная-торговля)
8. [Автономный бот](#автономный-бот)
9. [Статистика и мониторинг](#статистика-и-мониторинг)
10. [Конфигурация](#конфигурация)

---

## Обзор системы

Crypto Trading Bot - это система для автоматической и ручной торговли криптовалютами на бирже Binance. Бот работает в режиме **paper trading** (виртуальная торговля), что позволяет тестировать стратегии без риска потери реальных средств.

### Основные возможности:
- ✅ Автоматическая торговля на основе технических индикаторов
- ✅ Ручная торговля через веб-интерфейс
- ✅ Управление лимитными и рыночными ордерами
- ✅ Отслеживание позиций с Stop Loss и Take Profit
- ✅ Статистика торговли и производительности
- ✅ Управление рисками

---

## Архитектура

Система построена на архитектуре клиент-сервер с использованием:
- **Backend**: Go (Wails framework)
- **Frontend**: React + TypeScript + TailwindCSS
- **API**: Binance REST API и WebSocket для получения данных

### Основные модули:

```
┌─────────────────────────────────────────┐
│         Frontend (React)                │
│  - Dashboard (торговый интерфейс)      │
│  - Portfolio (портфель)                 │
│  - Analytics (аналитика)                │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│         App (Wails Backend)             │
│  - API endpoints                        │
│  - WebSocket handlers                   │
└─────────────────┬───────────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
┌───▼───┐  ┌─────▼─────┐  ┌───▼────┐
│Trading│  │  Binance  │  │Signals │
│Engine │  │  Client   │  │Handler │
└───┬───┘  └───────────┘  └────────┘
    │
┌───▼──────────┐  ┌──────────────┐
│PaperTrader  │  │OrderManager  │
│(Баланс/     │  │(Ордера)      │
│ Позиции)    │  │              │
└─────────────┘  └──────────────┘
```

---

## Основные компоненты

### 1. TradingEngine (Движок торговли)

**Расположение**: `internal/trading/engine.go`

Центральный компонент, управляющий всей торговой логикой.

#### Основные функции:
- **mainLoop()**: Главный цикл обработки (выполняется каждую секунду)
  - Обработка сигналов (`processSignals()`)
  - Проверка позиций (`checkPositions()`)
  - Обработка ордеров (`processOrders()`)

- **processSignals()**: Анализирует торговые сигналы и принимает решения о входе/выходе
- **checkPositions()**: Проверяет открытые позиции на срабатывание Stop Loss/Take Profit
- **openPosition()**: Открывает новую позицию на основе сигнала
- **closePosition()**: Закрывает позицию с расчетом PnL

#### Конфигурация:
```go
type EngineConfig struct {
    Symbol            string   // Торговая пара (например, "BTCUSDT")
    InitialBalance    float64  // Начальный баланс (по умолчанию: 50000 USDT)
    MaxPositionSize   float64  // Максимальный размер позиции
    RiskPerTrade      float64  // Риск на сделку (%)
    DefaultStopLoss   float64  // Стоп-лосс по умолчанию (2%)
    DefaultTakeProfit float64  // Тейк-профит по умолчанию (4%)
    MinConfidence     float64  // Минимальная уверенность сигнала
    MaxDailyTrades    int      // Максимум сделок в день
    CooldownMinutes   int      // Пауза между сделками (минуты)
}
```

### 2. PaperTrader (Виртуальный трейдер)

**Расположение**: `internal/trading/paper_trader.go`

Управляет виртуальным балансом и позициями без реальных сделок.

#### Основные функции:
- **OpenPosition()**: Открывает позицию, резервируя баланс
- **ClosePosition()**: Закрывает позицию, возвращает баланс + PnL
- **UpdatePosition()**: Обновляет нереализованный PnL позиции
- **ReserveBalance()**: Резервирует баланс для лимитных ордеров
- **RefundBalance()**: Возвращает зарезервированный баланс

#### Структура позиции:
```go
type Position struct {
    ID             string    // Уникальный ID
    Symbol         string    // Торговая пара
    Side           string    // "BUY"/"LONG" или "SELL"/"SHORT"
    EntryPrice     float64   // Цена входа
    Quantity       float64   // Количество
    StopLoss       float64   // Стоп-лосс
    TakeProfit     float64   // Тейк-профит
    OpenedAt       time.Time // Время открытия
    UnrealizedPnL  float64   // Нереализованная прибыль/убыток
    UnrealizedPnLPct float64 // Нереализованный PnL в %
}
```

### 3. OrderManager (Менеджер ордеров)

**Расположение**: `internal/trading/orders.go`

Управляет лимитными и рыночными ордерами.

#### Типы ордеров:
- **LIMIT**: Лимитный ордер - выполняется при достижении указанной цены
- **MARKET**: Рыночный ордер - выполняется немедленно по текущей цене

#### Статусы ордеров:
- **PENDING**: Ожидает выполнения
- **PARTIALLY_FILLED**: Частично выполнен
- **FILLED**: Полностью выполнен
- **CANCELLED**: Отменен

#### Основные функции:
- **CreateOrder()**: Создает новый ордер
- **CancelOrder()**: Отменяет ордер
- **ProcessLimitOrders()**: Обрабатывает лимитные ордера при изменении цены
- **GetOrders()**: Получает список ордеров

#### Логика выполнения лимитных ордеров:
1. При обновлении цены проверяются все PENDING лимитные ордера
2. Для BUY ордеров: выполняется, если текущая цена <= цене ордера
3. Для SELL ордеров: выполняется, если текущая цена >= цене ордера
4. При выполнении создается позиция (BUY) или закрывается существующая (SELL)

---

## Процесс торговли

### Автоматическая торговля (TradingEngine)

#### 1. Получение сигнала
```
SignalHandler → TradingEngine.processSignals()
```

Сигнал содержит:
- Направление (LONG/SHORT)
- Цену входа
- Уверенность (Confidence)
- ATR (Average True Range) для расчета Stop Loss/Take Profit

#### 2. Проверка возможности торговли
```go
canTrade() проверяет:
- Не превышен лимит сделок за день (MaxDailyTrades)
- Прошло ли достаточно времени с последней сделки (CooldownMinutes)
- Достаточна ли уверенность сигнала (MinConfidence)
```

#### 3. Расчет размера позиции
```go
positionSize = RiskManager.CalculatePositionSize(
    balance,      // Текущий баланс
    entryPrice,   // Цена входа
    stopLoss      // Стоп-лосс
)
```

Размер позиции рассчитывается так, чтобы при срабатывании стоп-лосса потеря не превышала `RiskPerTrade`.

#### 4. Расчет Stop Loss и Take Profit
```go
// Для LONG позиций:
stopLoss = entryPrice - 2 * ATR
takeProfit = entryPrice + 3 * ATR

// Для SHORT позиций:
stopLoss = entryPrice + 2 * ATR
takeProfit = entryPrice - 3 * ATR
```

Если ATR недоступен, используются проценты из конфигурации:
- Stop Loss: 2% от цены входа
- Take Profit: 4% от цены входа

#### 5. Открытие позиции
```go
PaperTrader.OpenPosition(position)
- Проверяет достаточность баланса
- Резервирует средства
- Создает позицию
```

#### 6. Мониторинг позиции
Каждую секунду проверяется:
- **Stop Loss**: Если цена достигла уровня стоп-лосса → закрытие позиции
- **Take Profit**: Если цена достигла уровня тейк-профита → закрытие позиции
- **Trailing Stop**: При прибыли >1% стоп-лосс перемещается к цене входа (breakeven)

#### 7. Закрытие позиции
```go
PaperTrader.ClosePosition(symbol, exitPrice, reason)
- Рассчитывает PnL
- Возвращает баланс + прибыль/убыток
- Создает запись в истории сделок
- Обновляет статистику
```

### Расчет PnL (Profit and Loss)

#### Для LONG позиций:
```go
PnL = (exitPrice - entryPrice) * quantity
PnL% = (exitPrice - entryPrice) / entryPrice * 100
```

#### Для SHORT позиций:
```go
PnL = (entryPrice - exitPrice) * quantity
PnL% = (entryPrice - exitPrice) / entryPrice * 100
```

---

## Управление ордерами

### Создание ордера

#### Лимитный ордер (LIMIT):
```go
CreateLimitOrder(symbol, side, price, quantity)
```

**Процесс:**
1. Для BUY ордеров: резервируется баланс (`ReserveBalance`)
2. Для SELL ордеров: проверяется наличие позиции и достаточное количество
3. Создается ордер со статусом PENDING
4. Ордер обрабатывается при обновлении цены

#### Рыночный ордер (MARKET):
```go
ExecuteMarketOrder(symbol, side, price, quantity)
```

**Процесс:**
1. Получается текущая рыночная цена
2. Для BUY: немедленно открывается позиция
3. Для SELL: немедленно закрывается позиция (полностью или частично)

### Обработка лимитных ордеров

Ордера обрабатываются автоматически при обновлении цены:

```go
ProcessOrdersForSymbol(symbol, currentPrice)
```

**Условия выполнения:**
- BUY ордер: `currentPrice <= orderPrice`
- SELL ордер: `currentPrice >= orderPrice`

### Отмена ордера

```go
CancelOrder(orderID)
```

**Процесс:**
1. Проверяется статус ордера (только PENDING или PARTIALLY_FILLED)
2. Для BUY ордеров: возвращается зарезервированный баланс
3. Статус ордера меняется на CANCELLED

---

## Управление позициями

### Открытие позиции

#### Автоматическое открытие:
- На основе торгового сигнала
- С автоматическим расчетом размера позиции
- С установкой Stop Loss и Take Profit

#### Ручное открытие:
- Через веб-интерфейс (TradePanel)
- Рыночный ордер: немедленное открытие
- Лимитный ордер: открытие при достижении цены

### Мониторинг позиций

Каждую секунду обновляется:
- **UnrealizedPnL**: Нереализованная прибыль/убыток
- **UnrealizedPnLPct**: Нереализованный PnL в процентах
- Проверка срабатывания Stop Loss/Take Profit

### Закрытие позиций

#### Автоматическое закрытие:
- **Stop Loss**: При достижении уровня стоп-лосса
- **Take Profit**: При достижении уровня тейк-профита
- **Signal Reversal**: При изменении направления сигнала (если уверенность >70%)

#### Ручное закрытие:
- Через веб-интерфейс (TradePanel)
- Рыночный ордер: немедленное закрытие
- Лимитный ордер: закрытие при достижении цены
- Частичное закрытие: возможно через частичную продажу

---

## Ручная торговля

### Интерфейс торговли (TradePanel)

**Расположение**: `frontend/src/components/trading/TradePanel.tsx`

#### Функциональность:
1. **Выбор направления**: Купить / Продать
2. **Тип ордера**: Limit / Market
3. **Ввод параметров**:
   - Цена (для лимитных ордеров)
   - Количество
   - Сумма ордера (автоматически рассчитывается)
4. **Быстрый выбор количества**: 0%, 25%, 50%, 75%, 100% от доступного баланса
5. **Слайдер**: Визуальный выбор процента баланса

#### Процесс размещения ордера:

1. **Валидация**:
   - Проверка заполнения всех полей
   - Проверка достаточности баланса (для покупки)
   - Проверка наличия позиции (для продажи)

2. **Создание ордера**:
   ```typescript
   App.PlaceOrder(symbol, side, orderType, price, quantity)
   ```

3. **Обработка**:
   - MARKET: Немедленное выполнение
   - LIMIT: Создание ордера, ожидание выполнения

4. **Обновление данных**:
   - Обновление баланса
   - Обновление позиций
   - Обновление истории сделок

### История сделок (TradeHistory)

**Расположение**: `frontend/src/components/analytics/TradeHistory.tsx`

#### Отображает:
1. **Открытые лимитные ордера**:
   - Тип (КУП/ПРОД)
   - Цена
   - Количество
   - Заполненное количество
   - Время создания
   - Кнопка отмены

2. **Закрытые сделки**:
   - Выполненные ордера
   - Закрытые позиции
   - Сортировка по времени (новые сверху)

---

## Автономный бот

### AutonomousBot

**Расположение**: `internal/bot/autonomous.go`

Автономный бот может работать независимо от веб-интерфейса.

#### Особенности:
- Торговля на нескольких символах одновременно
- Поддержка нескольких таймфреймов
- Использование WebSocket для получения данных в реальном времени
- Интеграция с ML-сервисом (опционально)

#### Запуск:
```go
StartBot(symbols []string, timeframes []string)
```

#### Процесс работы:
1. Подключение к Binance WebSocket
2. Подписка на обновления свечей для всех символов
3. Обработка данных свечей
4. Расчет технических индикаторов
5. Генерация торговых сигналов
6. Принятие решений о торговле через TradingEngine

---

## Статистика и мониторинг

### TradingStats

**Расположение**: `internal/trading/engine.go`

#### Метрики:
- **TotalTrades**: Общее количество сделок
- **WinningTrades**: Количество прибыльных сделок
- **LosingTrades**: Количество убыточных сделок
- **TotalPnL**: Общая прибыль/убыток (в USDT)
- **TotalPnLPercent**: Общая прибыль/убыток (в %)
- **WinRate**: Процент прибыльных сделок
- **AvgWin**: Средняя прибыль в процентах
- **AvgLoss**: Средний убыток в процентах
- **ProfitFactor**: Фактор прибыли (отношение прибыли к убыткам)
- **MaxDrawdown**: Максимальная просадка
- **CurrentDrawdown**: Текущая просадка
- **PeakBalance**: Пиковый баланс
- **DailyPnL**: Прибыль/убыток за день
- **TodayTrades**: Количество сделок за сегодня

### Обновление статистики

Статистика обновляется при:
- Открытии позиции
- Закрытии позиции
- Каждую секунду (для расчета текущих метрик)

### Портфель (Portfolio)

**Расположение**: `frontend/src/pages/Portfolio.tsx`

#### Отображает:
- **Общая стоимость**: Баланс + стоимость всех позиций
- **Доступный баланс**: Свободные средства
- **Нереализованный PnL**: Прибыль/убыток по открытым позициям
- **Список активов**: Все открытые позиции с деталями

---

## Конфигурация

### Настройки по умолчанию

**Расположение**: `internal/config/config.go`

```go
InitialBalance:    50000.0  // Начальный баланс (USDT)
MaxPositionSize:   0.1      // Максимальный размер позиции (10% от баланса)
RiskPerTrade:     0.02     // Риск на сделку (2%)
MinConfidence:    0.6      // Минимальная уверенность сигнала (60%)
MaxDailyTrades:   10       // Максимум сделок в день
CooldownMinutes:  5        // Пауза между сделками (5 минут)
```

### Изменение настроек

Настройки можно изменить через переменные окружения или напрямую в коде.

---

## Поток данных

### Получение рыночных данных

1. **REST API** (Binance Client):
   - Исторические свечи (`GetKlines`)
   - Текущие цены (`GetTicker24h`)
   - Все тикеры (`GetAllTickers`)

2. **WebSocket** (Binance WS Client):
   - Обновления свечей в реальном времени
   - Автоматическая подписка при выборе символа

### Обработка данных

```
Binance API/WS → IndicatorManager → SignalHandler → TradingEngine
```

1. **IndicatorManager**: Рассчитывает технические индикаторы (RSI, MACD, EMA и т.д.)
2. **SignalHandler**: Генерирует торговые сигналы на основе индикаторов
3. **TradingEngine**: Принимает решения о торговле на основе сигналов

---

## Безопасность и ограничения

### Paper Trading
- Все сделки виртуальные
- Нет риска потери реальных средств
- Идеально для тестирования стратегий

### Ограничения торговли
- **MaxDailyTrades**: Ограничение количества сделок в день
- **CooldownMinutes**: Пауза между сделками
- **MaxPositionSize**: Максимальный размер позиции
- **RiskPerTrade**: Ограничение риска на сделку

### Управление балансом
- Автоматическая проверка достаточности баланса
- Резервирование средств для лимитных ордеров
- Возврат средств при отмене ордеров

---

## Примеры использования

### Пример 1: Ручная покупка через лимитный ордер

1. Пользователь выбирает символ (например, BTCUSDT)
2. Выбирает "Купить" и "Limit"
3. Вводит цену: 90000 USDT
4. Вводит количество: 0.1 BTC
5. Нажимает "Купить BTC"
6. Ордер создается со статусом PENDING
7. Когда цена BTC падает до 90000 USDT или ниже, ордер выполняется
8. Позиция открывается автоматически

### Пример 2: Автоматическая торговля

1. TradingEngine получает сигнал LONG с уверенностью 75%
2. Проверяет ограничения (лимит сделок, пауза)
3. Рассчитывает размер позиции на основе риска
4. Рассчитывает Stop Loss и Take Profit
5. Открывает позицию
6. Мониторит позицию каждую секунду
7. При достижении Take Profit закрывает позицию с прибылью

### Пример 3: Закрытие позиции через Stop Loss

1. Позиция открыта по цене 90000 USDT
2. Stop Loss установлен на 88200 USDT (2% ниже)
3. Цена падает до 88200 USDT
4. TradingEngine автоматически закрывает позицию
5. Рассчитывается убыток: (88200 - 90000) * quantity
6. Баланс обновляется
7. Статистика обновляется

---

## Заключение

Crypto Trading Bot предоставляет полнофункциональную систему для автоматической и ручной торговли криптовалютами. Система использует paper trading для безопасного тестирования стратегий и включает в себя:

- ✅ Автоматическую торговлю на основе технических индикаторов
- ✅ Ручную торговлю через удобный веб-интерфейс
- ✅ Управление рисками и ограничениями
- ✅ Детальную статистику и мониторинг
- ✅ Поддержку лимитных и рыночных ордеров
- ✅ Автоматическое управление Stop Loss и Take Profit

Система спроектирована для масштабируемости и может быть легко расширена дополнительными функциями и стратегиями.

